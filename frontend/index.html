<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LexAI â€” Legal Intelligence System</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN SYSTEM â€” Deep law-library aesthetic
   Palette: aged parchment + deep ink + brass gold
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --ink:        #0f0e0c;
  --ink-mid:    #2a2520;
  --ink-soft:   #4a4540;
  --parchment:  #f5f0e8;
  --parchment2: #ede5d6;
  --parchment3: #e0d5c0;
  --brass:      #b8860b;
  --brass-light:#d4a017;
  --brass-pale: #f0e0a0;
  --crimson:    #8b1a1a;
  --jade:       #1a5c3a;
  --slate:      #2c3e50;
  --glass:      rgba(245,240,232,0.07);
  --shadow:     0 4px 32px rgba(15,14,12,0.25);
  --shadow-sm:  0 2px 12px rgba(15,14,12,0.15);
  --border:     rgba(184,134,11,0.25);
  --border-strong: rgba(184,134,11,0.5);
  --radius:     4px;
  --radius-lg:  8px;
  --transition: 0.22s cubic-bezier(0.4,0,0.2,1);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { font-size: 16px; scroll-behavior: smooth; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--ink);
  color: var(--parchment);
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€ Grain overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events: none; z-index: 9999;
  opacity: 0.6;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#login-screen {
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  background: var(--ink);
  z-index: 100;
  transition: opacity 0.6s ease, transform 0.6s ease;
}
#login-screen.hide {
  opacity: 0; transform: scale(1.04); pointer-events: none;
}

.login-backdrop {
  position: absolute; inset: 0; overflow: hidden;
}
.login-backdrop::before {
  content: '';
  position: absolute;
  top: -30%; left: -20%;
  width: 60%; height: 70%;
  background: radial-gradient(ellipse, rgba(184,134,11,0.12) 0%, transparent 70%);
  animation: breathe 8s ease-in-out infinite;
}
.login-backdrop::after {
  content: '';
  position: absolute;
  bottom: -20%; right: -10%;
  width: 50%; height: 60%;
  background: radial-gradient(ellipse, rgba(139,26,26,0.08) 0%, transparent 70%);
  animation: breathe 10s ease-in-out infinite reverse;
}
@keyframes breathe {
  0%,100% { transform: scale(1) translate(0,0); }
  50%      { transform: scale(1.1) translate(2%,2%); }
}

.login-card {
  position: relative; z-index: 1;
  width: min(420px, 92vw);
  padding: 52px 48px 44px;
  background: linear-gradient(145deg, #1a1714, #120f0c);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow:
    var(--shadow),
    inset 0 1px 0 rgba(184,134,11,0.15);
}

.login-emblem {
  text-align: center;
  margin-bottom: 36px;
}
.login-emblem .scales-icon {
  width: 52px; height: 52px;
  margin: 0 auto 16px;
  display: block;
}
.login-emblem h1 {
  font-family: 'Playfair Display', serif;
  font-size: 2rem;
  font-weight: 900;
  letter-spacing: -0.02em;
  color: var(--brass-light);
  line-height: 1;
}
.login-emblem p {
  font-size: 0.72rem;
  letter-spacing: 0.22em;
  text-transform: uppercase;
  color: var(--ink-soft);
  margin-top: 6px;
  font-family: 'DM Mono', monospace;
  font-weight: 300;
}

.form-group {
  margin-bottom: 20px;
}
.form-group label {
  display: block;
  font-size: 0.68rem;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: var(--brass);
  font-family: 'DM Mono', monospace;
  font-weight: 500;
  margin-bottom: 8px;
}
.form-group input {
  width: 100%;
  padding: 13px 16px;
  background: rgba(245,240,232,0.04);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--parchment);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.95rem;
  transition: var(--transition);
  outline: none;
}
.form-group input:focus {
  border-color: var(--brass);
  background: rgba(245,240,232,0.07);
  box-shadow: 0 0 0 3px rgba(184,134,11,0.12);
}
.form-group input::placeholder { color: rgba(245,240,232,0.25); }

.login-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, var(--brass), #8b6914);
  border: none; border-radius: var(--radius);
  color: var(--ink);
  font-family: 'DM Sans', sans-serif;
  font-weight: 600;
  font-size: 0.9rem;
  letter-spacing: 0.08em;
  cursor: pointer;
  margin-top: 8px;
  transition: var(--transition);
  position: relative; overflow: hidden;
}
.login-btn::after {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.15), transparent);
  opacity: 0; transition: var(--transition);
}
.login-btn:hover::after { opacity: 1; }
.login-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(184,134,11,0.35); }
.login-btn:active { transform: translateY(0); }
.login-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.login-error {
  margin-top: 14px;
  padding: 10px 14px;
  background: rgba(139,26,26,0.2);
  border: 1px solid rgba(139,26,26,0.4);
  border-radius: var(--radius);
  color: #f08080;
  font-size: 0.85rem;
  text-align: center;
  display: none;
}
.login-error.show { display: block; }

.login-hint {
  margin-top: 20px;
  text-align: center;
  font-size: 0.72rem;
  color: rgba(245,240,232,0.2);
  font-family: 'DM Mono', monospace;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app {
  display: none;
  min-height: 100vh;
  flex-direction: column;
}
#app.visible { display: flex; }

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  position: sticky; top: 0; z-index: 50;
  height: 60px;
  background: rgba(15,14,12,0.92);
  backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center;
  padding: 0 28px;
  gap: 20px;
}
.header-brand {
  display: flex; align-items: center; gap: 12px;
  flex-shrink: 0;
}
.header-brand svg { width: 24px; height: 24px; }
.header-brand span {
  font-family: 'Playfair Display', serif;
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--brass-light);
  letter-spacing: -0.01em;
}
.header-brand .sub {
  font-family: 'DM Mono', monospace;
  font-size: 0.6rem;
  letter-spacing: 0.2em;
  color: var(--ink-soft);
  text-transform: uppercase;
  font-weight: 300;
  display: block;
  line-height: 1;
  margin-top: 1px;
}

.header-sep {
  width: 1px; height: 24px;
  background: var(--border);
  flex-shrink: 0;
}

.header-status {
  display: flex; align-items: center; gap: 7px;
  font-family: 'DM Mono', monospace;
  font-size: 0.68rem;
  color: var(--ink-soft);
}
.status-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: #4caf7a;
  box-shadow: 0 0 6px #4caf7a;
  animation: pulse-dot 2.5s ease-in-out infinite;
}
.status-dot.loading { background: var(--brass); box-shadow: 0 0 6px var(--brass); }
.status-dot.offline { background: #888; box-shadow: none; animation: none; }
@keyframes pulse-dot {
  0%,100% { opacity: 1; } 50% { opacity: 0.5; }
}

.header-stats {
  margin-left: auto;
  display: flex; align-items: center; gap: 20px;
}
.stat-chip {
  display: flex; align-items: center; gap: 6px;
  font-family: 'DM Mono', monospace;
  font-size: 0.68rem;
  color: var(--ink-soft);
}
.stat-chip .val {
  color: var(--brass-light);
  font-weight: 500;
}

.header-user {
  display: flex; align-items: center; gap: 10px;
  padding: 6px 14px 6px 8px;
  border: 1px solid var(--border);
  border-radius: 20px;
  cursor: pointer;
  transition: var(--transition);
}
.header-user:hover { border-color: var(--border-strong); background: var(--glass); }
.header-user .avatar {
  width: 28px; height: 28px;
  background: linear-gradient(135deg, var(--brass), #6b4f0a);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem;
  font-weight: 700;
  color: var(--ink);
  font-family: 'DM Mono', monospace;
}
.header-user .uname {
  font-size: 0.8rem;
  font-weight: 500;
}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layout {
  display: grid;
  grid-template-columns: 260px 1fr;
  flex: 1;
  min-height: 0;
}

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  border-right: 1px solid var(--border);
  padding: 28px 20px;
  display: flex; flex-direction: column; gap: 28px;
  position: sticky; top: 60px;
  height: calc(100vh - 60px);
  overflow-y: auto;
  background: rgba(15,14,12,0.5);
}
.sidebar::-webkit-scrollbar { width: 4px; }
.sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.sidebar-section-title {
  font-family: 'DM Mono', monospace;
  font-size: 0.62rem;
  letter-spacing: 0.22em;
  text-transform: uppercase;
  color: var(--ink-soft);
  margin-bottom: 10px;
}

/* Filter pills */
.filter-group { display: flex; flex-direction: column; gap: 6px; }
.filter-pill {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px;
  border: 1px solid transparent;
  border-radius: var(--radius);
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.85rem;
  color: rgba(245,240,232,0.6);
}
.filter-pill:hover {
  background: var(--glass);
  border-color: var(--border);
  color: var(--parchment);
}
.filter-pill.active {
  background: rgba(184,134,11,0.12);
  border-color: var(--border-strong);
  color: var(--brass-light);
}
.filter-pill .pill-icon {
  width: 28px; height: 28px;
  border-radius: var(--radius);
  display: flex; align-items: center; justify-content: center;
  font-size: 0.85rem;
  flex-shrink: 0;
}
.filter-pill.active .pill-icon { background: rgba(184,134,11,0.2); }

/* History list */
.history-list { display: flex; flex-direction: column; gap: 4px; }
.history-item {
  padding: 9px 12px;
  border-radius: var(--radius);
  font-size: 0.8rem;
  color: rgba(245,240,232,0.5);
  cursor: pointer;
  transition: var(--transition);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  border: 1px solid transparent;
}
.history-item:hover {
  background: var(--glass);
  border-color: var(--border);
  color: var(--parchment);
}
.history-empty {
  font-size: 0.75rem;
  color: rgba(245,240,232,0.2);
  font-family: 'DM Mono', monospace;
  text-align: center;
  padding: 12px;
}

.sidebar-footer {
  margin-top: auto;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}
.logout-btn {
  width: 100%;
  padding: 10px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: rgba(245,240,232,0.4);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.82rem;
  cursor: pointer;
  transition: var(--transition);
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.logout-btn:hover {
  border-color: rgba(139,26,26,0.5);
  color: #f08080;
  background: rgba(139,26,26,0.08);
}

/* â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main {
  display: flex; flex-direction: column;
  min-height: calc(100vh - 60px);
  padding: 36px 48px;
  gap: 28px;
  max-width: 960px;
}

/* â”€â”€ Query box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.query-card {
  background: linear-gradient(145deg, #1a1714, #141210);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 28px 32px;
  box-shadow: var(--shadow-sm);
}
.query-card-header {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 20px;
}
.query-card-header h2 {
  font-family: 'Playfair Display', serif;
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--parchment);
}
.query-card-header .badge {
  font-family: 'DM Mono', monospace;
  font-size: 0.6rem;
  letter-spacing: 0.15em;
  padding: 3px 8px;
  background: rgba(184,134,11,0.15);
  border: 1px solid var(--border);
  border-radius: 20px;
  color: var(--brass);
  text-transform: uppercase;
}

.query-input-wrap {
  position: relative;
}
.query-textarea {
  width: 100%;
  min-height: 96px;
  resize: vertical;
  padding: 16px 52px 16px 18px;
  background: rgba(245,240,232,0.03);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--parchment);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.95rem;
  line-height: 1.6;
  outline: none;
  transition: var(--transition);
}
.query-textarea:focus {
  border-color: var(--brass);
  background: rgba(245,240,232,0.05);
  box-shadow: 0 0 0 3px rgba(184,134,11,0.1);
}
.query-textarea::placeholder { color: rgba(245,240,232,0.2); }

.query-actions {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 14px;
  gap: 12px;
}
.query-meta {
  font-family: 'DM Mono', monospace;
  font-size: 0.65rem;
  color: rgba(245,240,232,0.2);
}
.query-meta span { color: var(--brass); }

.submit-btn {
  display: flex; align-items: center; gap: 8px;
  padding: 11px 24px;
  background: linear-gradient(135deg, var(--brass), #7a5c0a);
  border: none; border-radius: var(--radius);
  color: var(--ink);
  font-family: 'DM Sans', sans-serif;
  font-weight: 600;
  font-size: 0.88rem;
  cursor: pointer;
  transition: var(--transition);
  white-space: nowrap;
}
.submit-btn:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(184,134,11,0.35);
}
.submit-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
.submit-btn svg { width: 15px; height: 15px; }

/* â”€â”€ Suggested queries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.suggestions {
  display: flex; flex-wrap: wrap; gap: 8px;
  margin-top: 16px;
}
.suggestion-chip {
  padding: 6px 14px;
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 0.76rem;
  color: rgba(245,240,232,0.45);
  cursor: pointer;
  transition: var(--transition);
  font-family: 'DM Sans', sans-serif;
}
.suggestion-chip:hover {
  border-color: var(--border-strong);
  color: var(--parchment);
  background: var(--glass);
}

/* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading-card {
  background: linear-gradient(145deg, #1a1714, #141210);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 36px 32px;
  display: none;
}
.loading-card.show { display: block; }

.loading-steps { display: flex; flex-direction: column; gap: 14px; }
.loading-step {
  display: flex; align-items: center; gap: 14px;
  opacity: 0.3;
  transition: opacity 0.4s ease;
}
.loading-step.active { opacity: 1; }
.loading-step.done   { opacity: 0.5; }
.step-indicator {
  width: 32px; height: 32px; flex-shrink: 0;
  border-radius: 50%;
  border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-family: 'DM Mono', monospace;
  font-size: 0.7rem;
  color: var(--brass);
  position: relative;
}
.loading-step.active .step-indicator {
  border-color: var(--brass);
  background: rgba(184,134,11,0.1);
}
.loading-step.active .step-indicator::after {
  content: '';
  position: absolute; inset: -4px;
  border-radius: 50%;
  border: 2px solid var(--brass);
  border-top-color: transparent;
  animation: spin 0.8s linear infinite;
}
.loading-step.done .step-indicator {
  border-color: var(--jade);
  background: rgba(26,92,58,0.15);
  color: #4caf7a;
}
@keyframes spin { to { transform: rotate(360deg); } }

.step-text { font-size: 0.85rem; color: rgba(245,240,232,0.6); }
.loading-step.active .step-text { color: var(--parchment); }

/* â”€â”€ Answer card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.answer-card {
  background: linear-gradient(145deg, #1a1714, #141210);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  display: none;
  animation: slideUp 0.4s cubic-bezier(0.4,0,0.2,1);
}
.answer-card.show { display: block; }
@keyframes slideUp {
  from { opacity: 0; transform: translateY(16px); }
  to   { opacity: 1; transform: translateY(0); }
}

.answer-header {
  padding: 20px 28px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.answer-header h3 {
  font-family: 'Playfair Display', serif;
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--brass-light);
  display: flex; align-items: center; gap: 8px;
}
.answer-header h3::before {
  content: '';
  display: inline-block;
  width: 8px; height: 8px;
  background: var(--brass);
  border-radius: 50%;
  box-shadow: 0 0 8px var(--brass);
}
.copy-btn {
  padding: 5px 12px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: rgba(245,240,232,0.4);
  font-family: 'DM Mono', monospace;
  font-size: 0.65rem;
  letter-spacing: 0.1em;
  cursor: pointer;
  text-transform: uppercase;
  transition: var(--transition);
}
.copy-btn:hover { border-color: var(--border-strong); color: var(--parchment); }

.answer-body {
  padding: 28px;
}
.answer-text {
  font-size: 0.95rem;
  line-height: 1.8;
  color: rgba(245,240,232,0.88);
}
.answer-text .cite {
  display: inline-flex; align-items: baseline;
  gap: 3px;
  background: rgba(184,134,11,0.1);
  border: 1px solid rgba(184,134,11,0.2);
  border-radius: 3px;
  padding: 1px 7px;
  font-family: 'DM Mono', monospace;
  font-size: 0.72em;
  color: var(--brass-light);
  white-space: nowrap;
  cursor: pointer;
  transition: var(--transition);
  vertical-align: middle;
}
.answer-text .cite:hover {
  background: rgba(184,134,11,0.2);
  border-color: rgba(184,134,11,0.4);
}

/* â”€â”€ Sources panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sources-header {
  padding: 16px 28px;
  border-top: 1px solid var(--border);
  background: rgba(0,0,0,0.2);
  display: flex; align-items: center; justify-content: space-between;
  cursor: pointer;
  transition: var(--transition);
}
.sources-header:hover { background: rgba(0,0,0,0.3); }
.sources-header span {
  font-family: 'DM Mono', monospace;
  font-size: 0.7rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--brass);
}
.sources-toggle {
  font-size: 0.65rem;
  color: rgba(245,240,232,0.3);
  font-family: 'DM Mono', monospace;
  transition: var(--transition);
}

.sources-body {
  padding: 0 28px 24px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 12px;
  overflow: hidden;
  transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1),
              padding 0.4s ease;
}
.sources-body.collapsed {
  max-height: 0; padding-top: 0; padding-bottom: 0; overflow: hidden;
}

.source-card {
  padding: 14px 16px;
  background: rgba(245,240,232,0.03);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  transition: var(--transition);
  cursor: default;
  position: relative;
  overflow: hidden;
}
.source-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 3px; height: 100%;
}
.source-card[data-type="FIR"]::before      { background: var(--crimson); }
.source-card[data-type="Panchnama"]::before { background: var(--jade); }
.source-card[data-type="Judgment"]::before  { background: var(--brass); }
.source-card[data-type="Unknown"]::before   { background: var(--slate); }

.source-card:hover {
  background: rgba(245,240,232,0.05);
  border-color: var(--border-strong);
  transform: translateY(-1px);
}

.source-rank {
  font-family: 'DM Mono', monospace;
  font-size: 0.62rem;
  color: var(--ink-soft);
  margin-bottom: 6px;
  display: flex; align-items: center; justify-content: space-between;
}
.source-score {
  font-size: 0.65rem;
  padding: 2px 7px;
  border-radius: 10px;
  background: rgba(184,134,11,0.1);
  color: var(--brass-light);
}
.source-filename {
  font-family: 'DM Mono', monospace;
  font-size: 0.75rem;
  color: var(--parchment);
  font-weight: 500;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  margin-bottom: 4px;
}
.source-meta {
  font-size: 0.72rem;
  color: rgba(245,240,232,0.35);
  display: flex; gap: 10px;
}
.source-type-badge {
  padding: 1px 7px;
  border-radius: 3px;
  font-size: 0.62rem;
  font-family: 'DM Mono', monospace;
  font-weight: 500;
}
.badge-FIR       { background: rgba(139,26,26,0.2); color: #e08080; border: 1px solid rgba(139,26,26,0.3); }
.badge-Panchnama { background: rgba(26,92,58,0.2);  color: #80c8a0; border: 1px solid rgba(26,92,58,0.3); }
.badge-Judgment  { background: rgba(184,134,11,0.15); color: var(--brass-light); border: 1px solid var(--border); }
.badge-Unknown   { background: rgba(60,60,70,0.3);  color: #aaa;   border: 1px solid rgba(100,100,110,0.3); }

.source-preview {
  margin-top: 8px;
  font-size: 0.75rem;
  color: rgba(245,240,232,0.3);
  line-height: 1.5;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

/* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state {
  flex: 1;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 16px;
  padding: 60px 0;
  text-align: center;
}
.empty-state svg { opacity: 0.12; }
.empty-state h3 {
  font-family: 'Playfair Display', serif;
  font-size: 1.3rem;
  font-weight: 400;
  font-style: italic;
  color: rgba(245,240,232,0.3);
}
.empty-state p {
  font-size: 0.82rem;
  color: rgba(245,240,232,0.18);
  max-width: 340px;
  line-height: 1.6;
}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 900px) {
  .layout { grid-template-columns: 1fr; }
  .sidebar {
    position: static; height: auto;
    border-right: none;
    border-bottom: 1px solid var(--border);
    flex-direction: row; flex-wrap: wrap;
    padding: 16px 20px;
    gap: 16px;
  }
  .sidebar-footer { display: none; }
  .main { padding: 24px 20px; }
  .header-stats { display: none; }
}
@media (max-width: 600px) {
  .login-card { padding: 36px 24px 32px; }
  .header { padding: 0 16px; }
  .header-brand .sub { display: none; }
  .sources-body { grid-template-columns: 1fr; }
}

/* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(184,134,11,0.2); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(184,134,11,0.4); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen">
  <div class="login-backdrop"></div>
  <div class="login-card">
    <div class="login-emblem">
      <!-- Scales of Justice SVG -->
      <svg class="scales-icon" viewBox="0 0 52 52" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="24.5" y="4" width="3" height="44" rx="1.5" fill="#b8860b"/>
        <rect x="6" y="18" width="40" height="2.5" rx="1.25" fill="#b8860b"/>
        <circle cx="26" cy="5.5" r="3.5" fill="#b8860b" opacity="0.6"/>
        <line x1="11" y1="20" x2="6" y2="34" stroke="#b8860b" stroke-width="1.5"/>
        <line x1="41" y1="20" x2="46" y2="34" stroke="#b8860b" stroke-width="1.5"/>
        <ellipse cx="8.5" cy="34" rx="7" ry="3" fill="#b8860b" opacity="0.35" stroke="#b8860b" stroke-width="1"/>
        <ellipse cx="43.5" cy="34" rx="7" ry="3" fill="#b8860b" opacity="0.35" stroke="#b8860b" stroke-width="1"/>
        <rect x="18" y="46" width="16" height="2.5" rx="1.25" fill="#b8860b" opacity="0.6"/>
      </svg>
      <h1>LexAI</h1>
      <p>Legal Intelligence System</p>
    </div>

    <div class="form-group">
      <label>User ID</label>
      <input type="text" id="login-user" placeholder="Enter your user ID" autocomplete="username">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
    </div>

    <button class="login-btn" id="login-btn" onclick="doLogin()">
      Access System
    </button>
    <div class="login-error" id="login-error">Invalid credentials. Please try again.</div>
    <div class="login-hint">Authorised personnel only Â· All sessions are logged</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">

  <!-- Header -->
  <header class="header">
    <div class="header-brand">
      <svg viewBox="0 0 24 24" fill="none">
        <rect x="10.5" y="1" width="3" height="22" rx="1.5" fill="#b8860b"/>
        <rect x="2" y="8" width="20" height="2" rx="1" fill="#b8860b"/>
        <ellipse cx="5" cy="16" rx="4" ry="1.5" fill="#b8860b" opacity="0.5" stroke="#b8860b" stroke-width="0.8"/>
        <ellipse cx="19" cy="16" rx="4" ry="1.5" fill="#b8860b" opacity="0.5" stroke="#b8860b" stroke-width="0.8"/>
        <line x1="5" y1="10" x2="5" y2="16" stroke="#b8860b" stroke-width="1.5"/>
        <line x1="19" y1="10" x2="19" y2="16" stroke="#b8860b" stroke-width="1.5"/>
      </svg>
      <div>
        <span>LexAI</span>
        <span class="sub">Legal Intelligence</span>
      </div>
    </div>

    <div class="header-sep"></div>

    <div class="header-status">
      <div class="status-dot" id="status-dot"></div>
      <span id="status-text">Connectingâ€¦</span>
    </div>

    <div class="header-stats">
      <div class="stat-chip">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
          <circle cx="6" cy="6" r="5" stroke="#b8860b" stroke-width="1"/>
          <circle cx="6" cy="6" r="2" fill="#b8860b" opacity="0.5"/>
        </svg>
        Vectors: <span class="val" id="stat-vectors">â€”</span>
      </div>
      <div class="stat-chip">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
          <rect x="1" y="3" width="10" height="2" rx="1" fill="#b8860b" opacity="0.6"/>
          <rect x="1" y="7" width="7" height="2" rx="1" fill="#b8860b" opacity="0.4"/>
        </svg>
        Index: <span class="val" id="stat-bm25">â€”</span>
      </div>
      <div class="stat-chip">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
          <path d="M2 2h8v8H2z" stroke="#b8860b" stroke-width="1" fill="none"/>
          <path d="M4 5h4M4 7h2" stroke="#b8860b" stroke-width="1" stroke-linecap="round"/>
        </svg>
        Model: <span class="val">Mistral 7B</span>
      </div>
    </div>

    <div class="header-user" onclick="doLogout()">
      <div class="avatar" id="user-avatar">A</div>
      <span class="uname" id="user-name">admin</span>
    </div>
  </header>

  <!-- Body -->
  <div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div>
        <div class="sidebar-section-title">Document Filter</div>
        <div class="filter-group">
          <div class="filter-pill active" data-filter="" onclick="setFilter(this)">
            <div class="pill-icon">âš–ï¸</div>
            All Documents
          </div>
          <div class="filter-pill" data-filter="FIR" onclick="setFilter(this)">
            <div class="pill-icon">ğŸ“‹</div>
            FIRs Only
          </div>
          <div class="filter-pill" data-filter="Panchnama" onclick="setFilter(this)">
            <div class="pill-icon">ğŸ”</div>
            Panchnamas
          </div>
          <div class="filter-pill" data-filter="Judgment" onclick="setFilter(this)">
            <div class="pill-icon">ğŸ›ï¸</div>
            Judgments
          </div>
        </div>
      </div>

      <div>
        <div class="sidebar-section-title">Recent Queries</div>
        <div class="history-list" id="history-list">
          <div class="history-empty">No queries yet</div>
        </div>
      </div>

      <div class="sidebar-footer">
        <button class="logout-btn" onclick="doLogout()">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
            <path d="M5 2H2v10h3M9 4l3 3-3 3M12 7H5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Sign Out
        </button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">

      <!-- Query card -->
      <div class="query-card">
        <div class="query-card-header">
          <h2>Legal Research Query</h2>
          <div class="badge" id="filter-badge">All Documents</div>
        </div>

        <div class="query-input-wrap">
          <textarea
            class="query-textarea"
            id="query-input"
            placeholder="Ask a legal questionâ€¦ e.g. 'What were the charges in FIR no. 42/2023?' or 'Summarise bail rulings under Section 439 CrPC'"
            rows="4"
          ></textarea>
        </div>

        <div class="query-actions">
          <div class="query-meta">
            Hybrid search â†’ BGE rerank â†’ <span>Mistral 7B Q4_K_M</span>
          </div>
          <button class="submit-btn" id="submit-btn" onclick="submitQuery()">
            <svg viewBox="0 0 15 15" fill="none">
              <path d="M1 7.5h13M8 2l6 5.5-6 5.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Search
          </button>
        </div>

        <div class="suggestions">
          <div class="suggestion-chip" onclick="fillSuggestion(this)">Charges under Section 302 IPC</div>
          <div class="suggestion-chip" onclick="fillSuggestion(this)">Bail conditions from 2023 judgments</div>
          <div class="suggestion-chip" onclick="fillSuggestion(this)">Panchnama seizure details</div>
          <div class="suggestion-chip" onclick="fillSuggestion(this)">Eyewitness statements in FIR</div>
          <div class="suggestion-chip" onclick="fillSuggestion(this)">Acquittal grounds cited</div>
        </div>
      </div>

      <!-- Loading indicator -->
      <div class="loading-card" id="loading-card">
        <div class="loading-steps">
          <div class="loading-step" id="step-1">
            <div class="step-indicator">1</div>
            <span class="step-text">Running hybrid search (Dense + BM25)â€¦</span>
          </div>
          <div class="loading-step" id="step-2">
            <div class="step-indicator">2</div>
            <span class="step-text">Reranking top 50 candidates with BGEâ€¦</span>
          </div>
          <div class="loading-step" id="step-3">
            <div class="step-indicator">3</div>
            <span class="step-text">Generating answer with Mistral 7Bâ€¦</span>
          </div>
        </div>
      </div>

      <!-- Answer -->
      <div class="answer-card" id="answer-card">
        <div class="answer-header">
          <h3>Answer</h3>
          <button class="copy-btn" onclick="copyAnswer()">Copy</button>
        </div>
        <div class="answer-body">
          <div class="answer-text" id="answer-text"></div>
        </div>
        <div class="sources-header" onclick="toggleSources()">
          <span>ğŸ“ Evidence Trail â€” <span id="source-count">0</span> sources cited</span>
          <span class="sources-toggle" id="sources-toggle">â–² collapse</span>
        </div>
        <div class="sources-body" id="sources-body"></div>
      </div>

      <!-- Empty state (shown before first query) -->
      <div class="empty-state" id="empty-state">
        <svg width="80" height="80" viewBox="0 0 80 80" fill="none">
          <circle cx="40" cy="40" r="38" stroke="#b8860b" stroke-width="1.5"/>
          <path d="M25 30 Q40 20 55 30" stroke="#b8860b" stroke-width="1.5" fill="none"/>
          <path d="M20 50 L36 50 M44 50 L60 50" stroke="#b8860b" stroke-width="1.5" stroke-linecap="round"/>
          <circle cx="40" cy="50" r="4" fill="#b8860b" opacity="0.4"/>
          <rect x="36" y="10" width="8" height="60" rx="4" fill="#b8860b" opacity="0.15"/>
        </svg>
        <h3>The scales await your query</h3>
        <p>Search across 26,000 FIRs, Panchnamas, and Judgments. Every answer is grounded in your documents with exact citations.</p>
      </div>

    </main>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const state = {
  activeFilter: '',
  history: JSON.parse(localStorage.getItem('lex_history') || '[]'),
  sourcesOpen: true,
  currentAnswer: '',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT â€” check session
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function boot() {
  try {
    const r = await api('/api/me');
    if (r.logged_in) showApp(r.user);
  } catch(_) {}

  // Allow Enter to submit login
  document.getElementById('login-pass').addEventListener('keydown', e => {
    if (e.key === 'Enter') doLogin();
  });
  document.getElementById('login-user').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('login-pass').focus();
  });
  // Allow Ctrl+Enter to submit query
  document.getElementById('query-input').addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') submitQuery();
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(url, method='GET', body=null) {
  const opts = {
    method,
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
  };
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(url, opts);
  return r.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin() {
  const btn = document.getElementById('login-btn');
  const err = document.getElementById('login-error');
  const uid = document.getElementById('login-user').value.trim();
  const pwd = document.getElementById('login-pass').value;

  if (!uid || !pwd) { showError('Please enter both user ID and password.'); return; }

  btn.disabled = true;
  btn.textContent = 'Authenticatingâ€¦';
  err.classList.remove('show');

  try {
    const r = await api('/api/login', 'POST', { username: uid, password: pwd });
    if (r.ok) {
      document.getElementById('login-screen').classList.add('hide');
      setTimeout(() => showApp(r.user), 550);
    } else {
      showError(r.error || 'Invalid credentials.');
    }
  } catch(_) {
    showError('Connection error. Is the server running?');
  }

  btn.disabled = false;
  btn.textContent = 'Access System';
}

function showError(msg) {
  const err = document.getElementById('login-error');
  err.textContent = msg;
  err.classList.add('show');
  // Shake animation
  const card = document.querySelector('.login-card');
  card.style.animation = 'shake 0.35s ease';
  setTimeout(() => card.style.animation = '', 350);
}

async function doLogout() {
  await api('/api/logout', 'POST');
  document.getElementById('app').classList.remove('visible');
  document.getElementById('app').style.display = 'none';
  const ls = document.getElementById('login-screen');
  ls.classList.remove('hide');
  document.getElementById('login-user').value = '';
  document.getElementById('login-pass').value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP SHOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showApp(user) {
  const app = document.getElementById('app');
  app.style.display = 'flex';
  requestAnimationFrame(() => app.classList.add('visible'));

  const initials = user.slice(0,2).toUpperCase();
  document.getElementById('user-avatar').textContent = initials;
  document.getElementById('user-name').textContent   = user;

  renderHistory();
  loadStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStats() {
  setStatus('loading', 'Connectingâ€¦');
  try {
    const r = await api('/api/stats');
    document.getElementById('stat-vectors').textContent =
      r.vectors > 0 ? r.vectors.toLocaleString() : 'Empty';
    document.getElementById('stat-bm25').textContent =
      r.bm25_ready ? 'Ready' : 'Buildingâ€¦';
    if (r.status === 'ready') {
      setStatus('online', `${r.vectors.toLocaleString()} vectors indexed`);
    } else {
      setStatus('offline', 'Index empty â€” run ingestion');
    }
  } catch(_) {
    setStatus('offline', 'Backend offline');
  }
}

function setStatus(type, text) {
  const dot  = document.getElementById('status-dot');
  const span = document.getElementById('status-text');
  dot.className  = 'status-dot' + (type === 'offline' ? ' offline' : type === 'loading' ? ' loading' : '');
  span.textContent = text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFilter(el) {
  document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  state.activeFilter = el.dataset.filter;
  const label = state.activeFilter || 'All Documents';
  document.getElementById('filter-badge').textContent = label;
  document.querySelector('.query-textarea').placeholder =
    state.activeFilter
      ? `Ask about ${state.activeFilter}sâ€¦ (e.g. details from a specific ${state.activeFilter})`
      : "Ask a legal questionâ€¦ e.g. 'What were the charges in FIR no. 42/2023?'";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUERY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitQuery() {
  const input   = document.getElementById('query-input');
  const question = input.value.trim();
  if (!question) { input.focus(); return; }

  // Disable controls
  document.getElementById('submit-btn').disabled = true;
  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('answer-card').classList.remove('show');

  // Show loader
  const loader = document.getElementById('loading-card');
  loader.classList.add('show');
  animateSteps();

  try {
    const result = await api('/api/query', 'POST', {
      question,
      doc_type: state.activeFilter || null,
    });

    renderAnswer(result);
    addHistory(question);
  } catch(e) {
    renderError('Network error: ' + e.message);
  }

  loader.classList.remove('show');
  resetSteps();
  document.getElementById('submit-btn').disabled = false;
}

let _stepTimer = null;
function animateSteps() {
  const steps = ['step-1','step-2','step-3'];
  let i = 0;
  steps.forEach(s => {
    const el = document.getElementById(s);
    el.className = 'loading-step';
  });
  document.getElementById('step-1').classList.add('active');

  _stepTimer = setInterval(() => {
    if (i < steps.length) {
      if (i > 0) {
        document.getElementById(steps[i-1]).className = 'loading-step done';
        document.getElementById(steps[i-1]).querySelector('.step-indicator').textContent = 'âœ“';
      }
      if (i < steps.length) {
        document.getElementById(steps[i]).classList.add('active');
      }
    }
    i++;
    if (i > steps.length) clearInterval(_stepTimer);
  }, 1800);
}

function resetSteps() {
  clearInterval(_stepTimer);
  ['step-1','step-2','step-3'].forEach(s => {
    const el = document.getElementById(s);
    el.className = 'loading-step';
    el.querySelector('.step-indicator').textContent = s.split('-')[1];
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ANSWER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAnswer(result) {
  state.currentAnswer = result.answer;
  const answerType = result.answer_type || 'document_grounded';

  // Header label changes based on answer type
  const headerEl = document.querySelector('.answer-header h3');
  if (answerType === 'general_ai_fallback') {
    headerEl.textContent = 'ğŸ¤– AI General Knowledge Answer';
    headerEl.style.color = '#d4a017';
  } else if (answerType === 'error') {
    headerEl.textContent = 'âš  System Error';
    headerEl.style.color = '#f08080';
  } else {
    headerEl.innerHTML = '<span style="display:inline-block;width:8px;height:8px;background:var(--brass);border-radius:50%;box-shadow:0 0 8px var(--brass);margin-right:8px"></span>Answer';
    headerEl.style.color = 'var(--brass-light)';
  }

  // AI fallback: show a clear warning banner
  let bannerHtml = '';
  if (answerType === 'general_ai_fallback') {
    bannerHtml = '<div style="margin-bottom:18px;padding:12px 16px;background:rgba(212,160,23,0.1);border:1px solid rgba(212,160,23,0.3);border-radius:4px;font-size:0.82rem;color:#d4a017;line-height:1.5;">&#9888;&#65039; <strong>No matching documents found in your index.</strong> This answer comes from Mistral 7B general knowledge â€” not your case files. It may not reflect the specific details of your documents.</div>';
  }

  // Clean the redundant AI preamble from the answer text
  let answerText = result.answer || '';
  if (answerType === 'general_ai_fallback') {
    answerText = answerText.replace(/^âš ï¸[^\n]*\n\n/, '').trim();
  }

  const formatted = formatCitations(answerText);
  document.getElementById('answer-text').innerHTML = bannerHtml + formatted;

  // Sources panel
  const body = document.getElementById('sources-body');
  const sources = result.sources || [];
  body.innerHTML = '';
  const sourcesHeader = document.querySelector('.sources-header');

  if (sources.length === 0 || answerType === 'general_ai_fallback' || answerType === 'error') {
    if (sourcesHeader) sourcesHeader.style.display = 'none';
    body.style.display = 'none';
  } else {
    if (sourcesHeader) sourcesHeader.style.display = '';
    body.style.display = '';
    sources.forEach(s => body.appendChild(buildSourceCard(s)));
    document.getElementById('source-count').textContent = sources.length;
    state.sourcesOpen = true;
    document.getElementById('sources-toggle').textContent = 'â–² collapse';
    body.classList.remove('collapsed');
  }

  document.getElementById('answer-card').classList.add('show');
  document.getElementById('answer-card').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function formatCitations(text) {
  // Transform [SOURCE: filename.pdf, Page N] â†’ styled inline badge
  return text.replace(
    /\[SOURCE:\s*([^\],]+),\s*Page\s*(\d+)\]/gi,
    (_, file, page) =>
      `<span class="cite" title="${file}, Page ${page}">ğŸ“„ ${file.split('/').pop()} p.${page}</span>`
  );
}

function buildSourceCard(s) {
  const div = document.createElement('div');
  div.className = 'source-card';
  div.dataset.type = s.doc_type || 'Unknown';

  const badgeClass = `badge-${s.doc_type || 'Unknown'}`;
  const score = (s.rerank_score * 100).toFixed(1);

  div.innerHTML = `
    <div class="source-rank">
      <span>#${s.rank}</span>
      <span class="source-score">${score}%</span>
    </div>
    <div class="source-filename" title="${s.source_file}">${s.source_file}</div>
    <div class="source-meta">
      <span class="source-type-badge ${badgeClass}">${s.doc_type}</span>
      <span>Page ${s.page_number}</span>
    </div>
    <div class="source-preview">${s.preview || ''}</div>
  `;
  return div;
}

function renderError(msg) {
  document.getElementById('answer-text').innerHTML =
    `<span style="color:#f08080">${msg}</span>`;
  document.getElementById('answer-card').classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyAnswer() {
  navigator.clipboard.writeText(state.currentAnswer).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 1800);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOURCES TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSources() {
  state.sourcesOpen = !state.sourcesOpen;
  const body   = document.getElementById('sources-body');
  const toggle = document.getElementById('sources-toggle');
  if (state.sourcesOpen) {
    body.classList.remove('collapsed');
    toggle.textContent = 'â–² collapse';
  } else {
    body.classList.add('collapsed');
    toggle.textContent = 'â–¼ expand';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addHistory(q) {
  state.history = [q, ...state.history.filter(h => h !== q)].slice(0, 12);
  localStorage.setItem('lex_history', JSON.stringify(state.history));
  renderHistory();
}

function renderHistory() {
  const list = document.getElementById('history-list');
  if (!state.history.length) {
    list.innerHTML = '<div class="history-empty">No queries yet</div>';
    return;
  }
  list.innerHTML = state.history.map(h =>
    `<div class="history-item" onclick="loadHistory(this)" title="${h}">${h}</div>`
  ).join('');
}

function loadHistory(el) {
  document.getElementById('query-input').value = el.title || el.textContent;
  document.getElementById('query-input').focus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUGGESTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fillSuggestion(el) {
  document.getElementById('query-input').value = el.textContent.trim();
  document.getElementById('query-input').focus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHAKE KEYFRAME (injected)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const shakeStyle = document.createElement('style');
shakeStyle.textContent = `
@keyframes shake {
  0%,100% { transform: translateX(0); }
  20%      { transform: translateX(-8px); }
  40%      { transform: translateX(8px); }
  60%      { transform: translateX(-5px); }
  80%      { transform: translateX(5px); }
}`;
document.head.appendChild(shakeStyle);
</script>
</body>
</html>